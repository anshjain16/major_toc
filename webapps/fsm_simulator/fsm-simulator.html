<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta
			name="author"
			content="Divyansh Muley , Ansh Jain , Karina Rajawat , Sujata More , Kartik Baghel" />
		<title>TOC LAB</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet" />
		<link rel="stylesheet" href="styles/fsm_simulator.css" />
	</head>
	<body>
		<nav class="navbar navbar-expand-lg navbar-dark bg-success">
			<div class="container-fluid">
				<a class="navbar-brand" href="home.html">TOC Lab</a>
				<button
					class="navbar-toggler"
					type="button"
					data-bs-toggle="collapse"
					data-bs-target="#navbarNav"
					aria-controls="navbarNav"
					aria-expanded="false"
					aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarNav">
					<ul class="navbar-nav ms-auto">
						<li class="nav-item">
							<a class="nav-link" aria-current="page" href="home.html">Home</a>
						</li>
						<li class="nav-item">
							<a class="nav-link active" aria-current="page" href="#"
								>Simulator</a
							>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="custom-automata-creator.html"
								>Automata Creator</a
							>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="minimizer.html">Minimizer</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="nfa2dfa.html">NFA to DFA</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="fsm2regex.html">FSM to RE</a>
						</li>
					</ul>
				</div>
			</div>
		</nav>
		<div class="container my-4">
			<header class="mb-4 text-center">
				<h1>Finite Automata Simulator & Manual Creator</h1>
				<p class="lead">Simulate and create DFAs and NFAs with ease.</p>
			</header>
			<ul class="nav nav-tabs" id="inputTabs" role="tablist">
				<li class="nav-item" role="presentation">
					<button
						class="nav-link active"
						id="scripted-tab"
						data-bs-toggle="tab"
						data-bs-target="#scriptedTab"
						type="button"
						role="tab"
						aria-controls="scriptedTab"
						aria-selected="true">
						Random/Scripted Automata
					</button>
				</li>
				<li class="nav-item" role="presentation">
					<button
						class="nav-link"
						id="manual-tab"
						data-bs-toggle="tab"
						data-bs-target="#manualTab"
						type="button"
						role="tab"
						aria-controls="manualTab"
						aria-selected="false">
						Manual Creation
					</button>
				</li>
			</ul>
			<div class="tab-content mt-3" id="inputTabsContent">
				<div
					class="tab-pane fade show active"
					id="scriptedTab"
					role="tabpanel"
					aria-labelledby="scripted-tab">
					<div class="card p-3">
						<h3>Create NFA/DFA (Scripted)</h3>
						<div class="mb-3">
							<button id="generateDFA" class="btn btn-primary">
								Generate Random DFA
							</button>
							<button id="generateENFA" class="btn btn-secondary">
								Generate Random NFA
							</button>
						</div>
						<div class="mb-3">
							<textarea
								id="fsm"
								class="form-control"
								rows="5"
								placeholder="Or write your own automaton definition"></textarea>
						</div>
						<p id="fsmError" class="text-danger"></p>
						<button id="createAutomaton" class="btn btn-success">
							Create Automaton
						</button>
					</div>
				</div>
				<div
					class="tab-pane fade"
					id="manualTab"
					role="tabpanel"
					aria-labelledby="manual-tab">
					<div class="card p-3">
						<h3>Manual Automaton Creation</h3>
						<div class="mb-3">
							<h4>Add State</h4>
							<input
								type="text"
								id="stateName"
								class="form-control"
								placeholder="State name" />
							<div class="form-check form-check-inline mt-2">
								<input
									class="form-check-input"
									type="radio"
									name="initialState"
									id="isInitial"
									value="initial" />
								<label class="form-check-label" for="isInitial">Initial</label>
							</div>
							<div class="form-check form-check-inline">
								<input
									class="form-check-input"
									type="checkbox"
									id="isAccepting" />
								<label class="form-check-label" for="isAccepting"
									>Accepting</label
								>
							</div>
							<button id="addState" class="btn btn-outline-primary mt-2">
								Add State
							</button>
						</div>
						<div class="mb-3">
							<h4>Add Transition</h4>
							<label for="fromState" class="form-label">From State</label>
							<select id="fromState" class="form-select"></select>
							<label for="transitionSymbol" class="form-label mt-2">
								Symbol (use ε for epsilon)
							</label>
							<input
								type="text"
								id="transitionSymbol"
								class="form-control"
								placeholder="Transition Symbol" />
							<label for="toState" class="form-label mt-2">To State</label>
							<select id="toState" class="form-select"></select>
							<button id="addTransition" class="btn btn-outline-primary mt-2">
								Add Transition
							</button>
						</div>
						<div class="mb-3">
							<h4>Current States</h4>
							<ul id="stateList" class="list-group"></ul>
						</div>
						<div class="mb-3">
							<h4>Current Transitions</h4>
							<ul id="transitionList" class="list-group"></ul>
						</div>
						<div class="mb-3">
							<label for="manualType" class="form-label">Automaton Type:</label>
							<select id="manualType" class="form-select">
								<option value="NFA" selected>NFA</option>
								<option value="DFA">DFA</option>
							</select>
						</div>
						<button id="generateManualAutomaton" class="btn btn-info">
							Generate Automaton from Manual Input
						</button>
					</div>
				</div>
			</div>
			<hr />
			<div class="card p-3">
				<h3>Simulate Automaton</h3>
				<div class="mb-3">
					<button id="generateRandomString" class="btn btn-primary" disabled>
						Random String
					</button>
					<button
						id="generateRandomAcceptableString"
						class="btn btn-success"
						disabled>
						Acceptable String
					</button>
					<button
						id="generateRandomUnacceptableString"
						class="btn btn-danger"
						disabled>
						Unacceptable String
					</button>
				</div>
				<div class="mb-3">
					<input
						id="inputString"
						type="text"
						class="form-control"
						placeholder="Input string to simulate"
						disabled />
				</div>
				<div class="mb-3">
					<button id="startStop" class="btn btn-warning" disabled>Start</button>
					<button id="inputPrevious" class="btn btn-outline-secondary" disabled>
						Previous
					</button>
					<button id="inputNext" class="btn btn-outline-secondary" disabled>
						Next
					</button>
				</div>
				<p>(It reads 2 symbols as input at a time)</p>
				<p id="inputError" class="text-danger"></p>
			</div>
			<div class="card p-3 mt-4">
				<h3>Transition Graph</h3>
				<p class="small">
					The FSM transition graph is displayed below. Current states are
					highlighted.
				</p>
				<div id="automatonGraph" class="border rounded p-3"></div>
			</div>
		</div>
		<footer class="bg-dark text-white py-4">
			<div class="container text-center">
				<p class="mb-1">&copy; 2025 TOC Lab. All Rights Reserved.</p>
				<p class="mb-0">
					Designed and Developed by Divyansh Muley, Ansh Jain, Karina Rajawat,
					Sujata More, Kartik Baghel
				</p>
			</div>
		</footer>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<script src="../assets/viz.js"></script>
		<script src="../../lib/browser/noam.js"></script>
		<script src="scripts/fsm_simulator.js"></script>
		<script>
			var regex = null;
			var automaton = null;
			var inputString = null;
			var nextSymbolIndex = 0;
			var currentStates = null;
			var inactiveStates = null;
			var previousStates = null;
			var nextStates = null;
			var inputIsRegex = false;
			var manualStates = [];
			var manualTransitions = [];

			function colorStates(states, cssClass) {
				if (states === undefined || states === null) {
					return;
				}
				states = getElementsOfStates(states);
				for (var i = 0; i < states.length; i++) {
					states[i].children("ellipse").each(function () {
						$(this).attr("class", cssClass);
					});
				}
			}

			function colorDiv(divId, intervals, cssClass) {
				var txt = $("#" + divId).html();
				var start = 0;
				var out = "";
				for (var i = 0; i < intervals.length; i++) {
					out += txt.slice(start, intervals[i][0]);
					out +=
						'<font class="' +
						cssClass +
						'">' +
						txt.slice(intervals[i][0], intervals[i][1]) +
						"</font>";
					start = intervals[i][1];
				}
				out += txt.slice(start);
				$("#" + divId).html(out);
			}

			function getElementsOfStates(states) {
				var retVal = [];
				for (var i = 0; i < states.length; i++) {
					$("title:contains('" + states[i].toString() + "')").each(function (
						index,
						element
					) {
						if ($(this).text() === states[i].toString()) {
							retVal.push($(this).parent());
						}
					});
				}
				return retVal;
			}

			function reorderCirclesInAcceptingStates(states) {
				var stateElements = getElementsOfStates(states);
				for (var i = 0; i < stateElements.length; i++) {
					var e1 = $(stateElements[i].children("ellipse")[0]);
					var e2 = $(stateElements[i].children("ellipse")[1]);
					e1.insertAfter(e2);
				}
			}

			function drawGraph() {
				var dotString = noam.fsm.printDotFormat(automaton);
				var gvizXml = Viz(dotString, {
					format: "svg",
					totalMemory: 100 * 1024 * 1024,
				});
				$("#automatonGraph").html(gvizXml);
				reorderCirclesInAcceptingStates(automaton.acceptingStates);
				$("#automatonGraph svg").width($("#automatonGraph").width());
			}

			function colorize() {
				colorStates(automaton.states, "inactiveStates");
				colorStates(previousStates, "previousState");
				colorStates(nextStates, "nextState");
				colorStates(currentStates, "currentState");
			}

			function updateAutomataSummary() {
				var summary = "<h4>Automata Summary</h4>";

				var stateNames = manualStates.map(function (s) {
					return s.name;
				});
				summary +=
					"<p><strong>States:</strong> " +
					(stateNames.length > 0 ? stateNames.join(", ") : "None") +
					"</p>";

				var initialState = manualStates.find(function (s) {
					return s.isInitial;
				});
				summary +=
					"<p><strong>Initial State:</strong> " +
					(initialState ? initialState.name : "None") +
					"</p>";

				var acceptingStates = manualStates
					.filter(function (s) {
						return s.isAccepting;
					})
					.map(function (s) {
						return s.name;
					});
				summary +=
					"<p><strong>Accepting States:</strong> " +
					(acceptingStates.length > 0 ? acceptingStates.join(", ") : "None") +
					"</p>";

				var alphabet = [];
				manualTransitions.forEach(function (t) {
					if (t.symbol !== "" && alphabet.indexOf(t.symbol) === -1) {
						alphabet.push(t.symbol);
					}
				});
				summary +=
					"<p><strong>Alphabet:</strong> " +
					(alphabet.length > 0 ? alphabet.join(", ") : "None") +
					"</p>";
				summary += "<p><strong>Transitions:</strong></p>";
				if (manualTransitions.length > 0) {
					summary += "<ul>";
					manualTransitions.forEach(function (t) {
						summary +=
							"<li>" +
							t.from +
							" --" +
							(t.symbol === "" ? "ε" : t.symbol) +
							"--> " +
							t.to +
							"</li>";
					});
					summary += "</ul>";
				} else {
					summary += "<p>No transitions added yet.</p>";
				}

				$("#automataSummary").html(summary);
			}

			$("#generateRandomString").click(function () {
				if ($("#startStop").text() === "Stop") {
					$("#startStop").click();
				}
				$("#inputString").val(
					Math.random() >= 0.5
						? noam.fsm.randomStringInLanguage(automaton).join("")
						: noam.fsm.randomStringNotInLanguage(automaton).join("")
				);
				onInputStringChange();
			});

			$("#generateRandomAcceptableString").click(function () {
				if ($("#startStop").text() === "Stop") {
					$("#startStop").click();
				}
				var s = noam.fsm.randomStringInLanguage(automaton).join("");
				$("#inputString").val(s);
				onInputStringChange();
			});

			$("#generateRandomUnacceptableString").click(function () {
				if ($("#startStop").text() === "Stop") {
					$("#startStop").click();
				}
				var s = noam.fsm.randomStringNotInLanguage(automaton).join("");
				$("#inputString").val(s);
				onInputStringChange();
			});

			$("#startStop").click(function () {
				if ($("#startStop").text() === "Start") {
					var r = $("#inputString").val();
					$("#inputString")
						.parent()
						.html(
							'<div id="inputString" class="input-div input-block-level monospaceRegex" placeholder="See if this fits"><br></div>'
						);
					$("#inputString").html(r === "" ? "<br>" : r);
					resetAutomaton();
					$("#inputString").removeAttr("contenteditable");
					$("#inputPrevious").attr("disabled", false);
					$("#inputNext").attr("disabled", false);
					$("#startStop").text("Stop");
				} else {
					var r = $("#inputString").text();
					$("#inputString")
						.parent()
						.html(
							'<input id="inputString" type="text" class="input-block-level monospaceRegex" placeholder="See if this fits">'
						);
					$("#inputString").keyup(onInputStringChange);
					$("#inputString").change(onInputStringChange);
					$("#inputString").val(r);
					$("#inputString").attr("contenteditable", "");
					$("#startStop").text("Start");
					$("#inputString").html($("#inputString").text());
					$("#inputString").focus();
				}
			});

			function onInputStringChange() {
				var chars = $("#inputString").val().split("");
				var isValidInputString = -1;
				for (var i = 0; i < chars.length; i++) {
					if (!noam.util.contains(automaton.alphabet, chars[i])) {
						isValidInputString = i;
						break;
					}
				}
				if (isValidInputString === -1) {
					$("#startStop").attr("disabled", false);
					$("#inputString").parent().addClass("success").removeClass("error");
					$("#inputError").hide();
				} else {
					$("#startStop").attr("disabled", true);
					$("#inputString").parent().removeClass("success").addClass("error");
					$("#inputError")
						.show()
						.text(
							"Error: input character at position " +
								isValidInputString +
								" is not in FSM alphabet."
						);
				}
			}

			function colorNextSymbol() {
				$("#inputString").html(inputString);
				if ($("#inputString").html() === "") {
					$("#inputString").html("<br>");
				}
				if (nextSymbolIndex < inputString.length) {
					colorDiv(
						"inputString",
						[[nextSymbolIndex, nextSymbolIndex + 1]],
						"nextSymbol"
					);
				}
			}

			function resetAutomaton() {
				currentStates = noam.fsm.computeEpsilonClosure(automaton, [
					automaton.initialState,
				]);
				inputString = $("#inputString").text();
				nextSymbolIndex = 0;
				colorize();
				colorNextSymbol();
			}

			$("#inputPrevious").click(function () {
				if (nextSymbolIndex > 0) {
					currentStates = noam.fsm.readString(
						automaton,
						inputString.substring(0, nextSymbolIndex - 1).split("")
					);
					nextSymbolIndex = nextSymbolIndex - 1;
					colorize();
					colorNextSymbol();
				}
			});

			$("#inputNext").click(function () {
				if (nextSymbolIndex < inputString.length) {
					currentStates = noam.fsm.makeTransition(
						automaton,
						currentStates,
						inputString[nextSymbolIndex]
					);
					nextSymbolIndex++;
					colorize();
					colorNextSymbol();
				}
			});

			function initialize() {
				inputString = "";
				currentStates = null;
				inactiveStates = null;
				previousStates = null;
				nextStates = null;
			}

			function generateAutomaton(fsmType) {
				automaton = noam.fsm.createRandomFsm(fsmType, 4, 3, 3);
				$("#fsm").val(noam.fsm.serializeFsmToString(automaton));
				$("#fsm").scrollTop(0);
				$("#fsm").focus();
				onAutomatonChange();
			}

			$("#generateDFA").click(function () {
				generateAutomaton(noam.fsm.dfaType);
			});

			$("#generateENFA").click(function () {
				generateAutomaton(noam.fsm.enfaType);
			});
			$("#fsm").on("keyup change", function () {
				if ($(this).val().trim() === "") {
					$("#createAutomaton").attr("disabled", true);
				} else {
					$("#createAutomaton").attr("disabled", false);
				}
			});
			$("#createAutomaton").click(function () {
				try {
					automaton = noam.fsm.parseFsmFromString($("#fsm").val());
					initialize();
					drawGraph();
					resetAutomaton();
					$(
						"#generateRandomString, #generateRandomAcceptableString, #generateRandomUnacceptableString, #inputString"
					).attr("disabled", false);
				} catch (e) {
					alert("Error creating automaton: " + e.message);
				}
			});
			function onAutomatonChange() {
				$("#automatonGraph").html("");
				$("#inputString").val("");
				$(
					"#generateRandomString, #generateRandomAcceptableString, #generateRandomUnacceptableString"
				).attr("disabled", true);
				$("#createAutomaton").attr("disabled", false);
				$("#startStop, #inputPrevious, #inputNext").attr("disabled", true);
				$("#inputString").parent().removeClass("success error");
				$("#inputError").hide();
			}
			function updateStateDropdowns() {
				var fromState = $("#fromState");
				var toState = $("#toState");
				fromState.empty();
				toState.empty();
				manualStates.forEach(function (state) {
					fromState.append(
						$("<option></option>").text(state.name).attr("value", state.name)
					);
					toState.append(
						$("<option></option>").text(state.name).attr("value", state.name)
					);
				});
			}

			$("#addState").click(function () {
				var name = $("#stateName").val().trim();
				if (!name) {
					alert("State name cannot be empty");
					return;
				}
				if (
					manualStates.some(function (s) {
						return s.name === name;
					})
				) {
					alert("State name must be unique");
					return;
				}
				var isInitial = $("#isInitial").is(":checked");
				if (isInitial) {
					manualStates.forEach(function (s) {
						s.isInitial = false;
					});
				}
				var isAccepting = $("#isAccepting").is(":checked");
				manualStates.push({
					name: name,
					isInitial: isInitial,
					isAccepting: isAccepting,
				});
				$("#stateName").val("");
				$("#isInitial, #isAccepting").prop("checked", false);
				updateStateDropdowns();
				var stateList = $("#stateList");
				stateList.empty();
				manualStates.forEach(function (state) {
					var text =
						state.name +
						(state.isInitial ? " (Initial)" : "") +
						(state.isAccepting ? " (Accepting)" : "");
					stateList.append($("<li></li>").text(text));
				});
				updateAutomataSummary();
			});

			$("#addTransition").click(function () {
				var fromState = $("#fromState").val();
				var toState = $("#toState").val();
				var symbol = $("#transitionSymbol").val().trim();
				if (symbol === "ε") symbol = "";
				if (!fromState || !toState || symbol === "") {
					alert("Please fill in all fields for the transition");
					return;
				}
				manualTransitions.push({from: fromState, symbol: symbol, to: toState});
				$("#transitionSymbol").val("");

				var transitionList = $("#transitionList");
				transitionList.empty();
				manualTransitions.forEach(function (trans) {
					var displaySymbol = trans.symbol === "" ? "ε" : trans.symbol;
					transitionList.append(
						$("<li></li>").text(
							trans.from + " --" + displaySymbol + "--> " + trans.to
						)
					);
				});

				// Update the automata summary.
				updateAutomataSummary();
			});

			$("#generateManualAutomaton").click(function () {
				var initialStates = manualStates.filter(function (s) {
					return s.isInitial;
				});
				if (initialStates.length !== 1) {
					alert("There must be exactly one initial state");
					return;
				}

				var states = manualStates.map(function (s) {
					return s.name;
				});
				var acceptingStates = manualStates
					.filter(function (s) {
						return s.isAccepting;
					})
					.map(function (s) {
						return s.name;
					});
				var initialState = initialStates[0].name;

				// Build alphabet from transitions (ignore epsilon transitions)
				var alphabet = [];
				manualTransitions.forEach(function (t) {
					if (t.symbol !== "" && alphabet.indexOf(t.symbol) === -1) {
						alphabet.push(t.symbol);
					}
				});

				// Build transitions in the required format.
				var transitionMap = {};
				manualTransitions.forEach(function (trans) {
					var key = trans.from + "," + trans.symbol;
					if (!transitionMap[key]) {
						transitionMap[key] = [];
					}
					transitionMap[key].push(trans.to);
				});

				var transitions = [];
				for (var key in transitionMap) {
					if (transitionMap.hasOwnProperty(key)) {
						var parts = key.split(",");
						transitions.push({
							fromState: parts[0],
							symbol: parts[1],
							toStates: transitionMap[key],
						});
					}
				}

				var manualAutomaton = {
					states: states,
					alphabet: alphabet,
					transitions: transitions,
					initialState: initialState,
					acceptingStates: acceptingStates,
				};

				var manualType = $("#manualType").val(); // "NFA" or "DFA"
				if (manualType === "DFA") {
					// Convert to DFA (first remove epsilon-transitions if any)
					manualAutomaton = noam.fsm.convertEnfaToNfa(manualAutomaton);
					manualAutomaton = noam.fsm.convertNfaToDfa(manualAutomaton);
					manualAutomaton = noam.fsm.minimize(manualAutomaton);
					// manualAutomaton = noam.fsm.convertStatesToNumbers(manualAutomaton);
				}

				// Serialize the created automaton and put it into the fsm textarea.
				var serialized = noam.fsm.serializeFsmToString(manualAutomaton);
				$("#fsm").val(serialized);

				//   $('#inputTabs a[href="#scriptedTab"]').tab('show');
				$("#createAutomaton").click();
				manualStates = [];
				manualTransitions = [];
				$("#stateList, #transitionList").empty();
				updateStateDropdowns();
			});
		</script>
	</body>
</html>
